<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="The Jornada Information Management Team">
<meta name="dcterms.date" content="2025-10-24">

<title>4. Databases – Jornada Data Commons</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../docs/im/sysadmin/chapter-05-data-publishing.html" rel="next">
<link href="../../../docs/im/sysadmin/chapter-03-websites-and-apps.html" rel="prev">
<link href="../../../img/jrn-logo-light.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-95f147d06fdb9f8ce149f95e323965f4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-57d88ccbd0ee5f8a904b59050ba3efd8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../img/jrn-logo-light.png" alt="" class="navbar-logo light-content">
    <img src="../../../img/jrn-logo-light.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Jornada Data Commons</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../docs/researcher/overview.html"> 
<span class="menu-text">Researcher Guide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../docs/im/overview.html"> 
<span class="menu-text">IM Guide</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-document-archive" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Document Archive</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-document-archive">    
        <li>
    <a class="dropdown-item" href="../../../templates/index.html">
 <span class="dropdown-text">Forms and templates</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../proposals-and-reports/index.html">
 <span class="dropdown-text">Recent proposals and reports</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../archive/index.html">
 <span class="dropdown-text">Miscellaneous documents</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/jornada-im/jornada-im.github.io" title="Jornada IM GitHub repository" class="quarto-navigation-tool px-1" aria-label="Jornada IM GitHub repository"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../docs/im/sysadmin/index.html">Full IM System Documentation</a></li><li class="breadcrumb-item"><a href="../../../docs/im/sysadmin/chapter-04-databases.html">4. Databases</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Metadata standards</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/standards/JRN_metadata_standards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Jornada Dataset Metadata Standards</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Procedures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/procedures/sop_metadata_publishing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SOP for updating datasets in metabase</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Hacks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/hacks/parse_trello_boards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parsing trello boards to csv</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../docs/im/sysadmin/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Full IM System Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/sysadmin/chapter-01-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. IM System Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/sysadmin/chapter-02-project-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. Project Management</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/sysadmin/chapter-03-websites-and-apps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Websites and Web Applications</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/sysadmin/chapter-04-databases.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">4. Databases</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/sysadmin/chapter-05-data-publishing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. Data Publishing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/im/sysadmin/chapter-06-server-admin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6. Servers and Server Administration</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/refs_and_links.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Useful references and links</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#host-setup" id="toc-host-setup" class="nav-link" data-scroll-target="#host-setup">Host setup</a>
  <ul class="collapse">
  <li><a href="#using-the-psql-client" id="toc-using-the-psql-client" class="nav-link" data-scroll-target="#using-the-psql-client">Using the <code>psql</code> client</a></li>
  <li><a href="#configuring-remote-access" id="toc-configuring-remote-access" class="nav-link" data-scroll-target="#configuring-remote-access">Configuring remote access</a></li>
  <li><a href="#postgresql-roles-for-lter_core_metabase" id="toc-postgresql-roles-for-lter_core_metabase" class="nav-link" data-scroll-target="#postgresql-roles-for-lter_core_metabase">PostgreSQL roles for LTER_core_metabase</a></li>
  </ul></li>
  <li><a href="#creating-databases" id="toc-creating-databases" class="nav-link" data-scroll-target="#creating-databases">Creating databases</a>
  <ul class="collapse">
  <li><a href="#first-some-tests-of-postgresql" id="toc-first-some-tests-of-postgresql" class="nav-link" data-scroll-target="#first-some-tests-of-postgresql">First some tests of PostgreSQL</a></li>
  <li><a href="#create-an-lter_core_metabase" id="toc-create-an-lter_core_metabase" class="nav-link" data-scroll-target="#create-an-lter_core_metabase">Create an lter_core_metabase</a></li>
  <li><a href="#applying-patches" id="toc-applying-patches" class="nav-link" data-scroll-target="#applying-patches">Applying patches</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#administration" id="toc-administration" class="nav-link" data-scroll-target="#administration">Administration</a>
  <ul class="collapse">
  <li><a href="#keeping-the-host-and-postgresql-up-to-date" id="toc-keeping-the-host-and-postgresql-up-to-date" class="nav-link" data-scroll-target="#keeping-the-host-and-postgresql-up-to-date">Keeping the host and PostgreSQL up to date</a></li>
  <li><a href="#updating-lter_core_metabase" id="toc-updating-lter_core_metabase" class="nav-link" data-scroll-target="#updating-lter_core_metabase">Updating LTER_core_metabase</a></li>
  <li><a href="#metabase-gotchas" id="toc-metabase-gotchas" class="nav-link" data-scroll-target="#metabase-gotchas">Metabase gotchas</a></li>
  <li><a href="#managing-roles-database-users" id="toc-managing-roles-database-users" class="nav-link" data-scroll-target="#managing-roles-database-users">Managing roles (database users)</a>
  <ul class="collapse">
  <li><a href="#administrator-tasks-to-manage-roles" id="toc-administrator-tasks-to-manage-roles" class="nav-link" data-scroll-target="#administrator-tasks-to-manage-roles">Administrator tasks to manage roles</a></li>
  <li><a href="#new-user-tasks" id="toc-new-user-tasks" class="nav-link" data-scroll-target="#new-user-tasks">New user tasks</a></li>
  <li><a href="#dropping-roles" id="toc-dropping-roles" class="nav-link" data-scroll-target="#dropping-roles">Dropping roles</a></li>
  </ul></li>
  <li><a href="#copy-the-database" id="toc-copy-the-database" class="nav-link" data-scroll-target="#copy-the-database">Copy the database</a></li>
  <li><a href="#backup-the-database" id="toc-backup-the-database" class="nav-link" data-scroll-target="#backup-the-database">Backup the database</a></li>
  <li><a href="#copy-development-jrn-metabase-to-production" id="toc-copy-development-jrn-metabase-to-production" class="nav-link" data-scroll-target="#copy-development-jrn-metabase-to-production">Copy development JRN Metabase to production</a></li>
  <li><a href="#migrate-a-database-to-a-new-host" id="toc-migrate-a-database-to-a-new-host" class="nav-link" data-scroll-target="#migrate-a-database-to-a-new-host">Migrate a database to a new host</a></li>
  <li><a href="#upgrade-cluster-to-new-version-of-postgres" id="toc-upgrade-cluster-to-new-version-of-postgres" class="nav-link" data-scroll-target="#upgrade-cluster-to-new-version-of-postgres">Upgrade cluster to new version of postgres</a></li>
  </ul></li>
  <li><a href="#metabase-schema-and-data-model" id="toc-metabase-schema-and-data-model" class="nav-link" data-scroll-target="#metabase-schema-and-data-model">Metabase schema and data model</a>
  <ul class="collapse">
  <li><a href="#schema-overview" id="toc-schema-overview" class="nav-link" data-scroll-target="#schema-overview">Schema overview</a></li>
  <li><a href="#attributes-datasetattributes-and-datasetattributeenumeration-tables" id="toc-attributes-datasetattributes-and-datasetattributeenumeration-tables" class="nav-link" data-scroll-target="#attributes-datasetattributes-and-datasetattributeenumeration-tables">Attributes (DataSetAttributes and DataSetAttributeEnumeration tables)</a></li>
  <li><a href="#some-thorny-issues" id="toc-some-thorny-issues" class="nav-link" data-scroll-target="#some-thorny-issues">Some thorny issues</a></li>
  </ul></li>
  <li><a href="#populating-metabase" id="toc-populating-metabase" class="nav-link" data-scroll-target="#populating-metabase">Populating metabase</a>
  <ul class="collapse">
  <li><a href="#editing-tools" id="toc-editing-tools" class="nav-link" data-scroll-target="#editing-tools">Editing tools</a></li>
  <li><a href="#populating-jrn-metabase-with-csv-imports" id="toc-populating-jrn-metabase-with-csv-imports" class="nav-link" data-scroll-target="#populating-jrn-metabase-with-csv-imports">Populating JRN Metabase with CSV imports</a></li>
  <li><a href="#populate-with-eml" id="toc-populate-with-eml" class="nav-link" data-scroll-target="#populate-with-eml">Populate with EML</a></li>
  <li><a href="#how-to-enter-or-update-a-dataset-manually-in-dataset-tables" id="toc-how-to-enter-or-update-a-dataset-manually-in-dataset-tables" class="nav-link" data-scroll-target="#how-to-enter-or-update-a-dataset-manually-in-dataset-tables">How to enter or update a dataset manually in <code>DataSet</code> tables</a>
  <ul class="collapse">
  <li><a href="#things-to-remember" id="toc-things-to-remember" class="nav-link" data-scroll-target="#things-to-remember">Things to remember</a></li>
  </ul></li>
  <li><a href="#tools" id="toc-tools" class="nav-link" data-scroll-target="#tools">Tools</a></li>
  </ul></li>
  <li><a href="#create-and-update-datasets" id="toc-create-and-update-datasets" class="nav-link" data-scroll-target="#create-and-update-datasets">Create and update datasets</a>
  <ul class="collapse">
  <li><a href="#setting-up-a-dataset-directory" id="toc-setting-up-a-dataset-directory" class="nav-link" data-scroll-target="#setting-up-a-dataset-directory">Setting up a dataset directory</a></li>
  <li><a href="#creating-or-updating-a-dataset-manually-in-dataset-tables" id="toc-creating-or-updating-a-dataset-manually-in-dataset-tables" class="nav-link" data-scroll-target="#creating-or-updating-a-dataset-manually-in-dataset-tables">Creating or updating a dataset manually in <code>DataSet</code> tables</a></li>
  <li><a href="#order-of-operations" id="toc-order-of-operations" class="nav-link" data-scroll-target="#order-of-operations">Order of operations</a></li>
  <li><a href="#things-to-remember-1" id="toc-things-to-remember-1" class="nav-link" data-scroll-target="#things-to-remember-1">Things to remember</a></li>
  </ul></li>
  <li><a href="#postgres-links" id="toc-postgres-links" class="nav-link" data-scroll-target="#postgres-links">Postgres links</a>
  <ul class="collapse">
  <li><a href="#postgresql-documentation" id="toc-postgresql-documentation" class="nav-link" data-scroll-target="#postgresql-documentation">PostgreSQL documentation</a></li>
  <li><a href="#platform-specific-packages-and-installation" id="toc-platform-specific-packages-and-installation" class="nav-link" data-scroll-target="#platform-specific-packages-and-installation">Platform specific packages and installation</a></li>
  <li><a href="#tutorials" id="toc-tutorials" class="nav-link" data-scroll-target="#tutorials">Tutorials</a></li>
  <li><a href="#tools-1" id="toc-tools-1" class="nav-link" data-scroll-target="#tools-1">Tools</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jornada-im/jornada-im.github.io/edit/main/docs/im/sysadmin/chapter-04-databases.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/jornada-im/jornada-im.github.io/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../docs/im/sysadmin/index.html">Full IM System Documentation</a></li><li class="breadcrumb-item"><a href="../../../docs/im/sysadmin/chapter-04-databases.html">4. Databases</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">4. Databases</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>The Jornada Information Management Team </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="setup" class="level1">
<h1>Setup</h1>
<p>JRN Metabase (<code>jrn_metabase</code>) is a PostgreSQL database that can be stored and accessed on either a local or remote host. Generally we configure it on a remote host for multi-user access. PostgreSQL uses a client/server model, which means that the database server application (<code>postgres</code>) runs on the host system and manages the databases and all incoming connections from client applications. Users can choose from a number of client applications to connect to a server and database(s), either locally (from the server’s host machine), or remotely. The standard, commandline client interface to PostgreSQL is <code>psql</code>, which can be, or already is, installed on most computers. We also use <a href="https://dbeaver.io/download/">DBeaver</a> as a graphical client for <code>jrn_metabase</code>. Links to PostgreSQL and community documentation are on the <a href="postgres_links.md">Postgres Links page</a>.</p>
<section id="host-setup" class="level2">
<h2 class="anchored" data-anchor-id="host-setup">Host setup</h2>
<p>For the remote host, we use an Ubuntu server running an up-to-date PostgreSQL server. To access a remote host over a terminal connection use:</p>
<pre><code>ssh &lt;username&gt;@&lt;host name or IP&gt;</code></pre>
<p>Note that if the host you are accessing is a Jornada server you will need to use the Jornada VPN from outside Wooton Hall.</p>
<p>To install PostgreSQL, use the most current installation method for the host’s operating system. We installed the default packages available in the latest version of Ubuntu Server. In Linux systems (Ubuntu, Debian, macOS, etc), installation of PostgreSQL creates a system user and a database server role that are both named <code>postgres</code>. The PostgreSQL administrative shell client, called `psql’, is also installed by default. Many more details on PostgreSQL server administration setup and administration can be found in the <a href="https://www.postgresql.org/docs/current/admin.html">official PG Administrator Guide</a>.</p>
<section id="using-the-psql-client" class="level3">
<h3 class="anchored" data-anchor-id="using-the-psql-client">Using the <code>psql</code> client</h3>
<p>When logged into the PostgreSQL host, any system user with sudoer privileges can switch to the <code>postgres</code> user and enter the <code>psql</code> shell with:</p>
<pre><code>sudo -u postgres psql</code></pre>
<p>The <code>postgres=#</code> prompt will appear indicating you have entered the shell in the <code>postgres</code> role, which is the default administrative role with superuser privileges. It has no password set on a new install(, so that will need to be set according to instructions below.)</p>
<p>Other PostgreSQL roles should be created for database users. Once these are created and remote access is configured on the host, <code>psql</code> can be run from remote clients (if installed) so that users can login to databases on the host using commands like:</p>
<pre><code>psql -U &lt;rolename&gt; -h &lt;hostname or IP&gt; -p &lt;postgres port&gt; &lt;database name&gt;</code></pre>
<p>In general the postgres port is 5432.</p>
</section>
<section id="configuring-remote-access" class="level3">
<h3 class="anchored" data-anchor-id="configuring-remote-access">Configuring remote access</h3>
<p>There are several configurations to set to allow remote access to a PostgreSQL database cluster. Some of these changes involve editing config files and some involve using <code>psql</code>. Most likely you’ll do this from your user account on the host machine. Check <a href="https://ubuntu.com/server/docs/install-and-configure-postgresql">these instructions</a> for updates.</p>
<ol type="1">
<li><p>Edit <code>postgresql.conf</code> to allow remote connections. To do this, open the file (usually in <code>/etc/postgresql/&lt;version&gt;/main</code>) and locate the <code>listen_addresses='localhost'</code> line, uncomment if needed, and change it to:</p>
<p>listen_addresses=‘*’</p></li>
<li><p>Now give the <code>postgres</code> user a password. Enter the <code>psql</code> as the default user (postgres)</p>
<pre><code> sudo -u postgres psql  # assuming logged on to host as a sudoer</code></pre>
<p>Then change the postgres role’s password to something more secure</p>
<pre><code> postgres=# ALTER USER postgres WITH ENCRYPTED PASSWORD '&lt;password&gt;';</code></pre></li>
<li><p>Alter the PostgreSQL authentication config file to allow user <code>postgres</code> to authenticate with md5 when making a remote (TCP/IP) connection.</p>
<pre><code> sudo vim /etc/postgresql/12/main/pg_hba.conf</code></pre>
<p>Add a line that looks like like this:</p>
<pre><code> hostssl   template1         postgres     0.0.0.0/0       scram-sha-256</code></pre>
<p>You could also restrict by database, or ip.</p></li>
<li><p>For other users, you can add a similar line to <code>pg_hba.conf</code> beneath the one above to allow remote connections - just change <code>postgres</code> to the user name. This can allow users from any IP (0.0.0.0/0) to login using md5. You could also let all users in this way:</p>
<pre><code>host    all     all      0.0.0.0/0      md5</code></pre>
<p>But it isn’t that secure.</p></li>
</ol>
</section>
<section id="postgresql-roles-for-lter_core_metabase" class="level3">
<h3 class="anchored" data-anchor-id="postgresql-roles-for-lter_core_metabase">PostgreSQL roles for LTER_core_metabase</h3>
<p>There are some recommended roles to add to a PostgreSQL cluster for LTER_core_metabase (defined <a href="https://github.com/lter/LTER-core-metabase/blob/master/docs/quick_start.md#1-create-users-and-assign-privileges">here</a>). This will most likely be done in psql while logged into the host.</p>
<ol type="1">
<li><p>Create a role for the database owner and set password</p>
<pre><code> postgres=# CREATE ROLE &lt;name&gt; CREATEDB CREATEROLE LOGIN;
 postgres=# ALTER USER &lt;name&gt; WITH ENCRYPTED PASSWORD '&lt;password&gt;';</code></pre></li>
<li><p>Create other roles specified for LTER_core_metabase. If you create these before creating the LTER_core_metabase in the steps below, they will be granted the correct permissions to the schema and tables.</p>
<pre><code> CREATE ROLE read_write_metabase;
 CREATE ROLE read_only_metabase;</code></pre>
<p>If for some reason permissions for these roles need correction, or a new role needs to be added, you might need to re-run the permission granting section in the database dump for LTER-core-metabase (<code>onebigfile.sql</code>), potentially after substituting in the new role name. JRN created a separate user for one of its metabases (jrn_metabase_dev) using this method.</p></li>
<li><p>After making changes on server restart the postgres server.</p>
<pre><code> sudo systemctl restart postgresql.service</code></pre></li>
</ol>
</section>
</section>
<section id="creating-databases" class="level2">
<h2 class="anchored" data-anchor-id="creating-databases">Creating databases</h2>
<section id="first-some-tests-of-postgresql" class="level3">
<h3 class="anchored" data-anchor-id="first-some-tests-of-postgresql">First some tests of PostgreSQL</h3>
<p>There are some PostgreSQL tools available in Linux userspace, so while logged in to the host, you can create a testing database for a user role with:</p>
<pre><code>createdb -O &lt;username&gt; &lt;databasename&gt;</code></pre>
<p>Or you can log into <code>psql</code> as a particular role and do:</p>
<pre><code>username=# CREATE DATABASE &lt;databasename&gt;</code></pre>
<p>Once this database is created you can log in to the database from the system shel (Note the uppercase -U flag to denote the user):</p>
<pre><code>psql -U &lt;username&gt; &lt;databasename&gt;</code></pre>
<p>Or connect from within psql:</p>
<pre><code>username=# \c &lt;databasename&gt;</code></pre>
<p>After logging in you can issue SQL commands and queries or use the <code>psql</code> metacommands that are prepended by a backslash and <a href="https://www.postgresql.org/docs/current/app-psql.html">described here</a>.</p>
</section>
<section id="create-an-lter_core_metabase" class="level3">
<h3 class="anchored" data-anchor-id="create-an-lter_core_metabase">Create an lter_core_metabase</h3>
<p>At Jornada, we are basically using a “stock” version of LTER-core-metabase. It only takes a few minor modifications to install the source.</p>
<ol type="1">
<li><p>On the host machine, clone the <a href="https://github.com/lter/LTER-core-metabase">lter_core_metabase git repository</a> then <code>cd</code> into the directory.</p></li>
<li><p>Edit the 2 sql files, <code>sql/00_create_db.sql</code> and <code>sql/onebigfile.sql</code>, to replace ‘%db_owner%’ with the name of the database owner role you created. This could be done with a standard text editor or <code>sed</code>.</p></li>
<li><p>Create the database:</p>
<pre><code> sudo -u postgres psql -f GitHub/LTER-core-metabase/sql/00_create_db.sql</code></pre>
<p>If there is a locale error you may edit locales in <code>00_create_db.sql</code> to one present on your system (<code>C.UTF-8</code> worked best for JRN), and/or create a new locale for your system (<code>locale-gen...</code>).</p></li>
<li><p>Set up the schema with <code>onebigfile.sql</code> (this is if logged on to host).</p>
<pre><code> psql -U &lt;db_owner username&gt; -h localhost -d lter_core_metabase &lt; GitHub/LTER-core-metabase/sql/onebigfile.sql</code></pre></li>
</ol>
</section>
<section id="applying-patches" class="level3">
<h3 class="anchored" data-anchor-id="applying-patches">Applying patches</h3>
<p>There are patches created for LTER_core_metabase periodically that may add new features or fix bugs between versions. These are in the <a href="https://github.com/lter/LTER-core-metabase/tree/migration/sql">migration branch</a> of the <code>LTER-core-metabase</code> GitHub repository. You should only apply the patches that are not already in <code>onebigfile.sql</code> and have not been already installed to your metabase. Check which patches are installed by consulting the <code>pkg_mgmt.version_tracker_metabase</code> table.</p>
<p>Some logical steps to install a patch are:</p>
<ol type="1">
<li><p>Log on to the server running <code>jrn_metabase</code></p></li>
<li><p>Pull any changes from <code>LTER-core-metabase</code> repository.</p></li>
<li><p>Make a copy of the patches for local editing:</p>
<pre><code>cp sql/44_add_provider_id_taxonomy_vw.sql sql_jrn/44_add_provider_id_taxonomy_vw.jrn.sql</code></pre></li>
<li><p>Edit the patch to make it compatibile with your metabase configuration. In most cases (assuming the patch is well-tessted) this should easy, and the main task is usually to replace <code>%db_owner%</code> with the appropriate Postgres role for the installed metabase.</p>
<pre><code>vim sql_jrn/33_semantic_annotation.jrn.sql</code></pre></li>
<li><p>Run the patch SQL by logging to the target database as <code>postgres</code> (or another authorized user; <code>sudo -u postgres psql jrn_metabase</code>) and issuing:</p>
<pre><code>\i GitHub/LTER-core-metabase/sql_jrn/33_semantic_annotation.jrn.sql</code></pre>
<p>using <code>psql</code> from the system prompt may work, though there may be permission problems with this:</p>
<pre><code>psql -U &lt;username&gt; -h &lt;hostname&gt; -d &lt;databasename&gt; &lt; GitHub/LTER-core-metabase/sql_jrn/33_semantic_annotation.sql</code></pre></li>
<li><p>Check that the patch was applied correctly!</p></li>
</ol>
</section>
</section>
</section>
<section id="administration" class="level1">
<h1>Administration</h1>
<section id="keeping-the-host-and-postgresql-up-to-date" class="level2">
<h2 class="anchored" data-anchor-id="keeping-the-host-and-postgresql-up-to-date">Keeping the host and PostgreSQL up to date</h2>
<p>The JRN Metabase is usually hosted on a server running Linux or a similar OS. In the case of Ubuntu/Debian systems, keep the OS and PostgreSQL up to date with <code>apt</code>. Important tasks are listed below. For full documentation of PostgreSQL server administration see the <a href="https://www.postgresql.org/docs/current/admin.html">official PG Administrator Guide</a>.</p>
</section>
<section id="updating-lter_core_metabase" class="level2">
<h2 class="anchored" data-anchor-id="updating-lter_core_metabase">Updating LTER_core_metabase</h2>
<p>Patches are periodically released and are available on the <a href="">migration branch</a> of the <a href="https://lter.github.io/LTER-core-metabase/">LTER GitHub repository</a>. They are pretty easy to install (see <a href="jrn_metabase_setup.md">setup</a> document) but they may or may not be needed depending on how our database has evolved. Discuss with the patch creator before installing.</p>
<p><strong>Is there a way to export patches if we change things?</strong></p>
</section>
<section id="metabase-gotchas" class="level2">
<h2 class="anchored" data-anchor-id="metabase-gotchas">Metabase gotchas</h2>
<ul>
<li>PostgreSQL interprets any keyword (like functions) or identifier (table and column names) to lowercase unless they are double quoted. So, identifiers that are created as case-sensitive using double quotes will always have to be double quoted.
<ul>
<li>One common convention used when writing SQL is to type SQL keywords in all caps, and identifiers in lowercase with underscores (snake_case).</li>
<li>Currently LTER_core_metabase (and JRN Metabase) violates this - table names and column names are case sensitive and pretty much always need to be double quoted.</li>
<li>See <a href="https://stackoverflow.com/questions/2878248/postgresql-naming-conventions">discussion here</a>.</li>
</ul></li>
</ul>
</section>
<section id="managing-roles-database-users" class="level2">
<h2 class="anchored" data-anchor-id="managing-roles-database-users">Managing roles (database users)</h2>
<section id="administrator-tasks-to-manage-roles" class="level3">
<h3 class="anchored" data-anchor-id="administrator-tasks-to-manage-roles">Administrator tasks to manage roles</h3>
<ol type="1">
<li><p>Log in to the <code>psql</code> shell either from a local terminal (<code>sudo -u postgres psql</code>) or from a remote client.</p>
<pre><code> psql -U &lt;role name&gt; -h &lt;host name or IP&gt; -p 5432 &lt;database name&gt;</code></pre></li>
<li><p>Add a role for the user and assign a password:</p>
<pre><code> postgres=# CREATE ROLE &lt;name&gt; &lt;OTHER OPTIONS&gt; LOGIN;
 postgres=# ALTER USER &lt;name&gt; WITH ENCRYPTED PASSWORD '&lt;password&gt;';</code></pre>
<p>Note that LOGIN roles are needed to make initial connections to a database, so normal users should have this. CREATE USER grants LOGIN automatically.</p></li>
<li><p>Email the user the new role/user name and password and ask them to change their password using the instructions below.</p></li>
<li><p>Grant or revoke the desired editing roles (list with <code>\du</code>) to user roles:</p>
<pre><code> postgres=# GRANT group_role TO role1, ... ;
 postgres=# REVOKE group_role FROM role1, ... ;</code></pre>
<p>In the case of LTER_core_metabase, the important roles are <code>read_only_metabase</code> and <code>read_write_metabase</code>.</p></li>
<li><p>To configure remote access (TCP/IP) for new users, they will need to be allowed in the <code>pg_hba.conf</code> file in some form. See the basics of this in the <a href="jrn_metabase_setup.md">setup page</a> and PostgreSQL specifics for <a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html">the <code>pg_hba.conf</code> file</a>.</p></li>
</ol>
</section>
<section id="new-user-tasks" class="level3">
<h3 class="anchored" data-anchor-id="new-user-tasks">New user tasks</h3>
<p>The administrator (site IM for now), will email you a username and password that will allow you to login to the host and the PostgreSQL server. You will need to at least change the PostgreSQL server password for your user account.</p>
<ol type="1">
<li><p>Open a terminal on your computer and check to see if you have the PostgreSQL client (<code>psql</code>) installed. The command below should return version info. If it doesn’t you need to install <code>psql</code>.</p>
<pre><code> psql --version</code></pre></li>
<li><p>Issue the following command from your terminal:</p>
<pre><code> psql -U &lt;username&gt; -h &lt;host name or IP&gt; -p 5432 -c "ALTER USER &lt;username&gt; WITH ENCRYPTED PASSWORD '&lt;new_password&gt;';" &lt;database name&gt;</code></pre>
<p>where anything in angle brackets needs to be replaced with your username, server, and database information. Don’t forget to leave the single quotes around your new password, but you will leave them out when accessing the database.</p></li>
</ol>
<p>If you don’t have <code>psql</code> available and can connect to <code>jrn_metabase</code> server with DBeaver, you may instead open an SQL console or SQL script window and type and execute this command:</p>
<pre><code>    ALTER USER &lt;username&gt; WITH ENCRYPTED PASSWORD '&lt;password&gt;';</code></pre>
<p>In either case you will need to change the password in your locally-stored connection info (e.g.&nbsp;for DBeaver and R) for future logins.</p>
</section>
<section id="dropping-roles" class="level3">
<h3 class="anchored" data-anchor-id="dropping-roles">Dropping roles</h3>
<p>User roles that no longer need access to a database or cluster should be dropped. The <a href="https://www.postgresql.org/docs/current/sql-droprole.html">DROP ROLE</a> SQL command will do this, as will the <a href="https://www.postgresql.org/docs/current/app-dropuser.html">dropuser</a> client application. Often a role will have ownership of database objects, so those ownerships need to be reassigned before dropping. See discussion <a href="https://www.postgresql.org/docs/current/role-removal.html">here</a>.</p>
</section>
</section>
<section id="copy-the-database" class="level2">
<h2 class="anchored" data-anchor-id="copy-the-database">Copy the database</h2>
<p>To copy a database, including schema and data, use:</p>
<pre><code>postgres=# CREATE DATABASE &lt;new_database_name&gt; WITH TEMPLATE &lt;template_database_name&gt;;</code></pre>
<p>More examples <a href="https://www.postgresqltutorial.com/postgresql-copy-database/">here</a>.</p>
</section>
<section id="backup-the-database" class="level2">
<h2 class="anchored" data-anchor-id="backup-the-database">Backup the database</h2>
<p>To backup the database the basic steps are to dump the database to an SQL file using the <code>pg_dump</code> utility:</p>
<pre><code>pg_dump -F p the_db_name &gt; the_backup.sql </code></pre>
<p>Some options for <code>pg_dump</code> are:</p>
<ul>
<li><code>-F c|d|t|p</code> output file format (custom, directory, tar, plain text)</li>
<li><code>-C</code> include commands to create database in dump</li>
<li><code>-O</code> no owner</li>
<li><code>-s</code> schema only</li>
<li><code>-b</code> include large objects in the dump</li>
<li><code>-v</code> verbose messages</li>
<li><code>-f</code> specifies the backup file name</li>
<li><code>-d</code> specifies the database to backup</li>
<li><code>-U</code> specifies the user to use</li>
<li><code>-h</code> specifies the host</li>
</ul>
<p>So, to create a backup to a client machine, for example, run:</p>
<pre><code>pg_dump -h &lt;hostname&gt; -U postgres -F p &lt;dbname&gt; &gt; ./path/dbname.bak.sql</code></pre>
<p>Backups using <code>pg_dump</code> can also be initiated from DBeaver or pgAdmin but not sure how yet.</p>
<p>A backup can be restored with some variation of:</p>
<pre><code>psql the_db_name &lt; the_backup.sql</code></pre>
<p>Basic info <a href="https://www.postgresqltutorial.com/postgresql-backup-database/">here</a>.</p>
<p>Regular database backups and backup rotation should be scheduled on the server - probably with <code>cron</code>. There are some scripts in the <code>lter_metabase_utils</code> repository that are based on <a href="https://wiki.postgresql.org/wiki/Automated_Backup_on_Linux">these</a>.</p>
</section>
<section id="copy-development-jrn-metabase-to-production" class="level2">
<h2 class="anchored" data-anchor-id="copy-development-jrn-metabase-to-production">Copy development JRN Metabase to production</h2>
<p>There are 2 versions of JRN metabase - a development copy called <code>jrn_metabase_dev</code> and the production version (<code>jrn_metabase</code>). Periodically, when the development database is well tested and stable, it should be copied to the production version. There are different ways to do this, the easiest of which is probably to delete <code>jrn_metabase</code>, create a new, empty database with that name, and then restore it with a nightly backup of <code>jrn_metabase_dev</code>.</p>
<p>On the host shell:</p>
<pre><code>dropdb jrn_metabase</code></pre>
<p>In psql:</p>
<pre><code>CREATE DATABASE jrn_metabase;</code></pre>
<p>On the host shell:</p>
<pre><code>psql -U &lt;username&gt; -d jrn_metabase -f /home/backups/postgresql/2021-04-06-daily/jrn_metabase_dev.sql</code></pre>
<p>The nightly backup will need to be unzipped first. It is also possible do it all in psql with something like:</p>
<pre><code>DROP DATABASE jrn_metabase;
CREATE DATABASE jrn_metabase WITH TEMPLATE jrn_metabase_dev;</code></pre>
</section>
<section id="migrate-a-database-to-a-new-host" class="level2">
<h2 class="anchored" data-anchor-id="migrate-a-database-to-a-new-host">Migrate a database to a new host</h2>
<p>To copy the database to a new host the basic steps are to dump the database to an SQL file using the <code>pg_dump</code> utility (see above), then copy this file to the new host and restore with:</p>
<pre><code>psql the_new_dev_db &lt; the_backup.sql</code></pre>
<p>This can feasably all be done in one command:</p>
<pre><code>pg_dump -C -h remotehost -U remoteuser dbname | psql -h localhost -U localuser dbname</code></pre>
<p>Or the SQL file can be dumped to localhost like this:</p>
<pre><code>ssh remoteuser@remotehost "pg_dump -U remoteuser dbname -h localhost -C --column-inserts" &gt; ~/Desktop/dbname.bak.sql</code></pre>
<p>See discussion <a href="https://stackoverflow.com/questions/1237725/copying-postgresql-database-to-another-server">here</a></p>
<p>Roles are also important - to export roles and restore them in a new cluster use:</p>
<pre><code>ssh remoteuser@remotehost "pg_dumpall --roles-only -U remoteuser -h localhost" &gt; ~/Desktop/dbname_roles.bak.sql</code></pre>
<p>See <a href="https://stackoverflow.com/questions/16618627/pg-dump-vs-pg-dumpall-which-one-to-use-to-database-backups">here?</a></p>
<p>Restoring seems to be easiest with a command like:</p>
<pre><code>pg_restore -C -h localhost -d jstream-data -U postgres /home/backups/postgresql/2024-09-17-daily/jstream-data.custom</code></pre>
<p>TODO: Flesh this out - how we do backups, how to restore them, especially during a potential server upgrade or other change?</p>
</section>
<section id="upgrade-cluster-to-new-version-of-postgres" class="level2">
<h2 class="anchored" data-anchor-id="upgrade-cluster-to-new-version-of-postgres">Upgrade cluster to new version of postgres</h2>
<ul>
<li>Follow <a href="https://www.yellowduck.be/posts/how-to-upgrade-postgresql-on-ubuntu-server">this tutorial</a></li>
</ul>
</section>
</section>
<section id="metabase-schema-and-data-model" class="level1">
<h1>Metabase schema and data model</h1>
<p>Including some issues.</p>
<section id="schema-overview" class="level2">
<h2 class="anchored" data-anchor-id="schema-overview">Schema overview</h2>
<p>There are 4 schemas available in LTER-core-metabase, but the <code>lter_metabase</code> schema is the primary collection of tables for describing metadata and data packages. Within this schema there are 3 primary types of tables:</p>
<ol type="1">
<li><code>EML</code>-prefixed tables
<ul>
<li>For controlled vocabularies (CV) for elements of the EML schema, network level CVs (file types, unit dictionaries)</li>
<li>often populated from network-level sources.</li>
<li>Infrequently updated.</li>
<li>CSV imports or patches might be the best way to populate</li>
<li>For now we are using what was already in LTER_core_metabase and hopefully updates will be community determined to some extent.</li>
</ul></li>
<li><code>List</code>-prefixed tables
<ul>
<li>Controlled vocabularies more specific to the site</li>
<li>We will need to populate with JRN personnel, keyword thesauri, our sites (and bounding boxes), and possibly methods documents and taxa.</li>
<li>Only a subset of the LTER Keyword CV is currently present in the keywords list table.</li>
<li>Somewhat frequently updated</li>
<li>CSV imports or manual entry/updates to populate</li>
</ul></li>
<li><code>DataSet</code>-prefixed tables
<ul>
<li>Metadata assigned to specific datasets in the database</li>
<li>Enter/update records anytime a dataset is added to or updated in JRN Metabase.</li>
<li>Populate with CSV imports, EML using EML2MB (see notes below), or “manually” by entering or updating metadata records for a dataset (see instructions below).</li>
</ul></li>
</ol>
</section>
<section id="attributes-datasetattributes-and-datasetattributeenumeration-tables" class="level2">
<h2 class="anchored" data-anchor-id="attributes-datasetattributes-and-datasetattributeenumeration-tables">Attributes (DataSetAttributes and DataSetAttributeEnumeration tables)</h2>
<p>Storage type refers to the data type in which attribute values are stored in EML (See EMLStorageTypes table). We use integer, float, string, date, and boolean types for our data.</p>
<p>In some ways storageType corresponds to MeasurementScaleDomainIDs</p>
<ul>
<li>Categorical attributes (
<ul>
<li>nominalEnum: un-ordered categorical stored as a string or integer storageType</li>
<li>ordinalEnum: ordered categorical, usually stored as an integer</li>
</ul></li>
<li>Numeric attributes (
<ul>
<li>interval: un-ordered categorical stored as a string or integer storageType</li>
<li>ratio: ordered categorical, usually stored as an integer</li>
</ul></li>
</ul>
<p>Stuff on the internet about this:</p>
<ul>
<li>https://gradcoach.com/nominal-ordinal-interval-ratio/</li>
<li>https://www.statology.org/levels-of-measurement-nominal-ordinal-interval-and-ratio/</li>
</ul>
</section>
<section id="some-thorny-issues" class="level2">
<h2 class="anchored" data-anchor-id="some-thorny-issues">Some thorny issues</h2>
<ul>
<li><p>Personnel</p>
<ul>
<li>The contact person/org is assigned in the boilerplate table. Can there be more than one contact listed for a data package?</li>
<li>Is there any way to place a single person in multiple roles for a data package? The schema seems to prevent this now.</li>
<li>What about associated parties - how do they work between lter metabase and EDI?</li>
<li>For now there is a generic contact for every data package, and John is not listed as contact for anything that he was previously listed in.</li>
</ul></li>
<li><p>DataSetTemporal table</p>
<ul>
<li>I’m not sure how to populate this yet.</li>
<li>It needs to change as we update data packages and there doesn’t seem to be a way to automatically update it. Maybe part of our R scripts?</li>
</ul></li>
<li><p>DataSetSites</p>
<ul>
<li>Needs to be populated but not sure what the best way is.</li>
</ul></li>
<li><p>There doesn’t seem to be an easy way to tie geographicdescription to attributes.</p></li>
<li><p>CodeID - we can list all codes used in datafiles in the ListCodes table, then reference in DatasetAttributeEnumeration. But should we?</p></li>
</ul>
</section>
</section>
<section id="populating-metabase" class="level1">
<h1>Populating metabase</h1>
<p>The <a href="https://lter.github.io/LTER-core-metabase/">LTER-core-metabase documentation</a> on GitHub is the primary source for understanding this process. The steps to populate the lter-metabase schema are summarized below (<a href="https://lter.github.io/LTER-core-metabase/populate.html">and in the docs</a>), with notes on how this process is being adapted for JRN Metabase. Note that before populating, it is worthwhile to learn a little about the LTER Metabase schema and how data are stored within it. See <a href="metabase-schema-and-data-model">notes here</a> about that.</p>
<section id="editing-tools" class="level2">
<h2 class="anchored" data-anchor-id="editing-tools">Editing tools</h2>
<p>In general we are using <code>psql</code>, python, or DBeaver to populate and edit our databases. DBeaver has <a href="https://dbeaver.com/docs/wiki/">excellent documentation</a>, but users will need to install it and set it up with their user/role and password to log into JRN Metabases. PgAdmin and other tools might be useful too.</p>
</section>
<section id="populating-jrn-metabase-with-csv-imports" class="level2">
<h2 class="anchored" data-anchor-id="populating-jrn-metabase-with-csv-imports">Populating JRN Metabase with CSV imports</h2>
<p>Tables in JRN Metabase can be updated by importing CSV files containing metadata using <code>psql</code>, DBeaver, or python. The relevant SQL command is <code>COPY FROM</code>. Setting up incoming CSVs to match the table being copied to will help, and in LTER Metabases it will be best to start with parent tables (`DataSets’ in particular?) so that foreign key rules won’t be violated.</p>
<p>In server-side <code>psql</code> use:</p>
<pre><code>COPY persons(first_name, last_name, dob, email)
FROM '/home/username/sampledb/persons.csv' 
DELIMITER ',' 
CSV HEADER;  # if there is a header in the csv</code></pre>
<p>In client side <code>psql</code> use <code>\copy</code>, and be aware that not all roles will be permitted to do client-site operations. All the columns in the csv need a destination column in the database table or else an error will result. <a href="https://www.postgresqltutorial.com/import-csv-file-into-postgresql-table/">This tutorial page</a> helps.</p>
<p><code>COPY FROM</code> operations with CSV files can also be initiated from python using a <a href="https://www.psycopg.org/"><code>psycopg</code></a> database connection. Some python scripts and modules for this are available in the <a href="https://github.com/jornada_im/jrn_metabase_tools">jrn_metabase_tools</a> repository.</p>
<p>In DBeaver, highlight the destination table and use the ‘Import’ tool, then select the CSV file to import. The tool allows you to match columns between CSV and database tables and create/ignore columns if needed. Setting up incoming CSVs to match the tables in the schema beforehand will help. Documentation <a href="https://dbeaver.com/docs/wiki/Data-transfer/">here</a>.</p>
</section>
<section id="populate-with-eml" class="level2">
<h2 class="anchored" data-anchor-id="populate-with-eml">Populate with EML</h2>
<p>There is a tool being developed called EML2MB which might allow import of metadata using EML, but not ready for primetime yet.</p>
</section>
<section id="how-to-enter-or-update-a-dataset-manually-in-dataset-tables" class="level2">
<h2 class="anchored" data-anchor-id="how-to-enter-or-update-a-dataset-manually-in-dataset-tables">How to enter or update a dataset manually in <code>DataSet</code> tables</h2>
<p>The <code>DataSet</code>-prefixed tables need to be added to or updated to add/update JRN Datasets in the database. These tables are all linked by the <code>DataSetID</code> columns, so new rows will need this key added, and updates to DataSets will need to take place with the correct <code>DataSetID</code>s. These numbers correspond to the DataSet IDs we currently use for our JRN data packages (210001001, for example).</p>
<p>Before adding a new DataSet to the JRN Metabase, keep in mind that NOT ALL parts of the data package can be added directly to the database. The data entities (CCSVs or other files) and the abstract and methods documents (as .docx, markdown, etc) should be kept in a folder in our usual file system. You will add path to these files in JRN Metabase, but not the files themselves (for now). Once you have a folder to refer to, the order of operations to add a new dataset to JRN MEtabase is:</p>
<ol type="1">
<li>In the <code>lter_metabase</code> schema, open the <code>DataSets</code> table and add a new row.</li>
<li>Enter a package ID in the <code>DataSetID</code> column.</li>
<li>Populate the rest of the row with the dataset title, path/name of the abstract file, the publication date, and other info.</li>
<li>The ‘Boilerplate’ column has a parent table in the <code>mb2eml_r</code> schema that identifies seldom changing metadata elements such as <intellectualrights>.</intellectualrights></li>
<li>Open the <code>DataSetEntities</code> table and enter information for the data entities. If there are more than one you will enter multiple new rows and order them in the `<code>EntitySortOrder</code> column. The <code>DataSetID</code> and <code>EntitySortOrder</code> columns together identify <dataentities> in other tables, such as for “DataSetAttributes.”</dataentities></li>
<li>Edit the “DataSetAttributes” table
<ul>
<li>Rows containing a <code>DataSetID</code> and <code>EntitySortOrder</code> of one will be for describing the attribues in the first dataEntity included in the dataset.</li>
</ul></li>
</ol>
<section id="things-to-remember" class="level3">
<h3 class="anchored" data-anchor-id="things-to-remember">Things to remember</h3>
<ul>
<li>Make sure there are not extra spaces entered in the database. For example, no extra spaces around the “ColumnName” entries in <code>DataSetAttributes</code> table.</li>
<li>Column attributes with <code>nominalEnum</code> measurement scale types are tricky. To make them work:
<ul>
<li>set the <code>StorageType</code> to integer or string, depending what they are</li>
<li>shouldn’t need any <code>Unit</code>, <code>NumberType</code> or other values.</li>
</ul></li>
<li>Free text column attributes can have a <code>nominalText</code> measurement scale and a string <code>StorageType</code>.
<ul>
<li>shouldn’t need any <code>Unit</code>, <code>NumberType</code> or other values.</li>
</ul></li>
<li>Don’t know how <code>ordinalEnum</code> and <code>ordinalText</code> measurement scales work yet. Can’t find much documentation about it, though the <a href="https://eml.ecoinformatics.org/eml-schema.html#the-eml-attribute-module---attribute-level-information-within-dataset-entities">EML schema</a> might define them.</li>
</ul>
</section>
</section>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">Tools</h2>
<ul>
<li><a href="https://www.sql-workbench.eu/index.html">SQL Workbench</a> can compare database schemas and data (a Java app).</li>
<li><a href="https://www.psycopg.org/">psycopg</a> is a PostgreSQL database driver for python.</li>
<li><a href="https://www.sqlalchemy.org/">SQL Alchemy</a> is an ORM and collection of database tools for python (it can use psycopg as a driver).</li>
<li><a href="http://docs.peewee-orm.com/en/latest/">peewee</a> a lighter-weight ORM.</li>
</ul>
</section>
</section>
<section id="create-and-update-datasets" class="level1">
<h1>Create and update datasets</h1>
<section id="setting-up-a-dataset-directory" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-a-dataset-directory">Setting up a dataset directory</h2>
<p>Jornada datasets consist of data files, metadata, and sometimes additional files. Not all of these can be stored directly in the JRN Metabase. So, each Jornada dataset should have a dedicated directory, usually on the Jornada shared drive. These directories are typically prefixed with the Jornada dataset ID number. As noted below, all data entities to be incuded with the published dataset, as well as some metadata to be attached, will be stored in this directory. It is also a good place to store scripts used to QA/QC datafiles and publish finished datasets.</p>
</section>
<section id="creating-or-updating-a-dataset-manually-in-dataset-tables" class="level2">
<h2 class="anchored" data-anchor-id="creating-or-updating-a-dataset-manually-in-dataset-tables">Creating or updating a dataset manually in <code>DataSet</code> tables</h2>
<p>Metadata specific to datasets are stored in <code>DataSet</code>-prefixed tables in JRN Metabase. To create a new dataset record in JRN Metabase, new records (rows) must be added to these tables. To update an existing dataset in JRN Metabase, existing records in <code>DataSet</code> tables must be altered, and new records (rows) may be added. The <code>DataSet</code> tables are all linked by the <code>DataSetID</code> columns, so new records added to a table will require that this key be added, and updates to any dataset will need to take place in records with the correct, corresponding <code>DataSetID</code>. The <code>DataSetID</code> numbers in JRN Metabase correspond to the jornada dataset IDs we currently use for all our data packages (210001001, for example).</p>
<p>Before adding a new dataset to JRN Metabase, keep in mind that NOT ALL metadata for the data package will be added directly to the database. Long-form text metadata, particularly the abstract and methods for the dataset, are typically kept in the dataset directory as .docx, markdown or other text files. The filenames for the abstract and methods will be added to JRN Metabase, but not the metadata themselves.</p>
<p>Additionally, the data entities (CSV tables, geoTIFFs, zip archives, PDFs, etc…) that will be included with your dataset must also be in the dataset directory. You will add filenames for these to JRN Metabase, but not the files themselves.</p>
</section>
<section id="order-of-operations" class="level2">
<h2 class="anchored" data-anchor-id="order-of-operations">Order of operations</h2>
<ol type="1">
<li>In the <code>lter_metabase</code> schema, open the <code>DataSets</code> table and add a new row.</li>
<li>Enter a package ID in the <code>DataSetID</code> column.</li>
<li>Populate the rest of the row with the dataset title, name of the abstract file, publication date, and other info.</li>
<li>The ‘Boilerplate’ column has a parent table in the <code>mb2eml_r</code> schema that identifies seldom changing metadata elements such as <intellectualrights> and <project> metadata. Choose a boilerplate value that matches your project and dataset.</project></intellectualrights></li>
<li>Open the <code>DataSetEntities</code> table and enter (or update) a record for each of the data entities. Each of these records refer to a file your dataset directory that will be published as part of the dataset.
<ul>
<li>If the dataset has more than one entity you will enter multiple new rows and order them in the <code>EntitySortOrder</code> column.</li>
<li>The <code>DataSetID</code> and <code>EntitySortOrder</code> columns together will be used to identify data entities in other tables, such as in the <code>DataSetAttributes</code> table (below).</li>
</ul></li>
<li>If your data package has tabular data entities (<code>DataSetEntities.EntityType</code>=“dataTable”) open the <code>DataSetAttributes</code> table to describe the columns in each tabular data entity.
<ul>
<li>Rows with an <code>EntitySortOrder</code> of “1” will describe the column attributes in the first dataEntity included in the dataset.</li>
<li>Additional rows with the same <code>DataSetID</code> and incremented <code>EntitySortOrders</code> (2, 3, 4…) will describe column attributes in additional data entities for the dataset.</li>
</ul></li>
<li>If the <code>DataSetAttributes</code> table defines any colums as categorical variables by having a <code>MeasurementScaleDomain</code> of “nominalEnum”, you will need look at the categorical data column in the data table and add a record for each categorical variable code used to the <code>DataSetAttributeEnumeration</code> table, using codes defined in the <code>ListCodes</code> table.</li>
<li>Continue until all table are filled out… a sensible order of operations from here (will add more detail later) would be to fill out:
<ul>
<li><code>DataSetMethod</code> with information about the methods file in your dataset directory, usually named “methods.<datasetid>.md” or similar.</datasetid></li>
<li><code>DataSetKeywords</code> with appropriate keywords chosen from the <code>ListKeywords</code> table.</li>
<li><code>DataSetPersonnel</code> with relevant personnel <code>NameID</code>s chosen from the <code>ListPeople</code> table.</li>
<li><code>DataSetSites</code> with a site identifier chosen from the <code>ListSites</code> table.</li>
<li><code>DataSetTemporal</code> to define the time periods covered in the data.</li>
</ul></li>
</ol>
<p>Note that many columns have constraints set - they will need to contain values, and these may be required to come from a parent table.</p>
</section>
<section id="things-to-remember-1" class="level2">
<h2 class="anchored" data-anchor-id="things-to-remember-1">Things to remember</h2>
<ul>
<li>Make sure there are not extra spaces entered in the database. For example, no extra spaces around the “ColumnName” entries in <code>DataSetAttributes</code> table.</li>
<li>Column attributes with <code>nominalEnum</code> measurement scale types are tricky. To make them work:
<ul>
<li>set the <code>StorageType</code> to integer or string, depending what they are</li>
<li>shouldn’t need any <code>Unit</code>, <code>NumberType</code> or other values.</li>
</ul></li>
<li>Free text column attributes can have a <code>nominalText</code> measurement scale and a string <code>StorageType</code>.
<ul>
<li>shouldn’t need any <code>Unit</code>, <code>NumberType</code> or other values.</li>
</ul></li>
<li>Don’t know how <code>ordinalEnum</code> and <code>ordinalText</code> measurement scales work yet. Can’t find much documentation about it, though the <a href="https://eml.ecoinformatics.org/eml-schema.html#the-eml-attribute-module---attribute-level-information-within-dataset-entities">EML schema</a> might define them.</li>
</ul>
</section>
</section>
<section id="postgres-links" class="level1">
<h1>Postgres links</h1>
<section id="postgresql-documentation" class="level2">
<h2 class="anchored" data-anchor-id="postgresql-documentation">PostgreSQL documentation</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/">Current version docs</a>
<ul>
<li><a href="https://www.postgresql.org/docs/current/tutorial.html">The tutorial (Part I)</a> is useful for general learning.</li>
<li><a href="https://www.postgresql.org/docs/current/admin.html">Part III, the Administration section</a> covers topics like installation, server and database configuration, and managing roles.</li>
<li><a href="https://www.postgresql.org/docs/current/reference.html">Part VI, the Reference section</a> describes SQL commands and client/server tools like <code>initdb</code>, <code>pg_dump</code>, <code>createdb</code> and <code>psql</code>.</li>
</ul></li>
</ul>
</section>
<section id="platform-specific-packages-and-installation" class="level2">
<h2 class="anchored" data-anchor-id="platform-specific-packages-and-installation">Platform specific packages and installation</h2>
<ul>
<li><a href="https://ubuntu.com/server/docs/databases-postgresql">Ubuntu</a> and <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-20-04">Ubuntu on Digital Ocean droplets</a></li>
<li><a href="https://wiki.debian.org/PostgreSql">Debian</a></li>
</ul>
</section>
<section id="tutorials" class="level2">
<h2 class="anchored" data-anchor-id="tutorials">Tutorials</h2>
<ul>
<li>The <a href="https://www.youtube.com/watch?v=qw--VYLpxG4">4 Hour Learn PostgreSQL Tutorial</a> is excellent.</li>
<li><a href="https://www.postgresqltutorial.com/">PostgreSQL Tutorials website</a></li>
<li><a href="http://sol.gfxile.net/galaxql.html">GalaxQL</a> (not specific to PostgreSQL, but fun)</li>
<li><a href="https://www.youtube.com/watch?v=HXV3zeQKqGY">4 Hour Learn SQL Tutorial</a></li>
<li><a href="https://www.youtube.com/watch?v=aUfPf-clLLs">PostgreSQL Database Administration for beginners</a></li>
</ul>
</section>
<section id="tools-1" class="level2">
<h2 class="anchored" data-anchor-id="tools-1">Tools</h2>
<ul>
<li><a href="https://www.sql-workbench.eu/index.html">SQL Workbench</a> can compare database schemas and data (a Java app).</li>
<li><a href="https://www.psycopg.org/">psycopg</a> is a PostgreSQL database driver for python.</li>
<li><a href="https://www.sqlalchemy.org/">SQL Alchemy</a> is an ORM and collection of database tools for python (it can use psycopg as a driver).</li>
<li><a href="http://docs.peewee-orm.com/en/latest/">peewee</a> a lighter-weight ORM.</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jornada-im\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../docs/im/sysadmin/chapter-03-websites-and-apps.html" class="pagination-link" aria-label="3. Websites and Web Applications">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">3. Websites and Web Applications</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../docs/im/sysadmin/chapter-05-data-publishing.html" class="pagination-link" aria-label="5. Data Publishing">
        <span class="nav-page-text">5. Data Publishing</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jornada-im/jornada-im.github.io/edit/main/docs/im/sysadmin/chapter-04-databases.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/jornada-im/jornada-im.github.io/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>